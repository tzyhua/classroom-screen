<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÊïôÂÆ§Ëû¢ÂπïÁ≥ªÁµ± v5.0 (ÊóóËâ¶Áâà)</title>
    <style>
        /* --- 1. Âü∫Á§éË®≠ÂÆö --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
            font-family: "ÂæÆËªüÊ≠£ÈªëÈ´î", sans-serif;
            overscroll-behavior: none; 
        }

        #bg-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=1920&auto=format&fit=crop');
            background-size: cover; background-position: center; z-index: -1;
            transition: background-image 0.5s;
        }

        /* --- Áè≠Á¥öÂàáÊèõÂàó --- */
        .class-bar {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(8px);
            padding: 8px 10px; border-radius: 50px; display: flex; gap: 5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); z-index: 200;
        }
        .class-btn {
            border: none; background: transparent; padding: 8px 16px; border-radius: 20px;
            font-size: 16px; font-weight: bold; color: #666; cursor: pointer; transition: all 0.2s;
        }
        .class-btn:hover { background: #eee; }
        .class-btn.active { background: #2196F3; color: white; box-shadow: 0 2px 8px rgba(33, 150, 243, 0.4); }

        /* --- Â∫ïÈÉ® Dock --- */
        .dock-container {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(12px);
            padding: 12px 24px; border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3); display: flex; gap: 20px;
            z-index: 100;
        }
        .dock-btn {
            width: 60px; height: 60px; border: none; background: white;
            border-radius: 16px; font-size: 30px; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s;
            user-select: none;
        }
        .dock-btn:active { transform: scale(0.9); }

        /* --- Ë¶ñÁ™óÈÄöÁî® --- */
        .widget-window {
            position: absolute; width: 340px; 
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            display: none; flex-direction: column; overflow: hidden;
            top: 100px; left: 50px;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .window-header {
            background: #f8f9fa; padding: 15px; cursor: move;
            display: flex; justify-content: space-between; align-items: center;
            user-select: none; border-bottom: 1px solid #eee; touch-action: none;
        }
        .window-title { font-weight: bold; font-size: 18px; color: #333; }
        .window-subtitle { font-size: 12px; color: #2196F3; margin-left: 8px; font-weight: normal; }
        .close-btn {
            width: 30px; height: 30px; background: #ff5f57; border-radius: 50%;
            color: white; text-align: center; line-height: 28px; font-weight: bold; cursor: pointer;
        }
        .window-content { padding: 15px; }

        /* --- Â∞èÁµÑ & ‰ΩúÊ•≠Ê®£Âºè --- */
        .score-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .score-card { background: #fff; border: 2px solid #eee; border-radius: 12px; padding: 10px; text-align: center; }
        .score-animal { font-size: 24px; display: block; }
        .score-value { font-size: 28px; font-weight: bold; color: #333; margin: 5px 0; }
        .score-actions button { width: 30px; height: 30px; border-radius: 50%; border: none; color: white; cursor: pointer; margin: 0 5px;}
        .btn-add { background: #4CAF50; } .btn-minus { background: #ff9800; }

        .hw-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px; }
        .student-circle {
            width: 45px; height: 45px; border-radius: 50%; background: #f0f0f0; border: 2px solid #ddd;
            display: flex; justify-content: center; align-items: center; font-weight: bold; color: #666; cursor: pointer; user-select: none;
        }
        .status-done { background: #4CAF50; border-color: #388E3C; color: white; }
        .status-missing { background: #ff5252; border-color: #D32F2F; color: white; }
        .hw-summary { background: #eee; border-radius: 8px; padding: 10px; font-size: 14px; text-align: center; color: #555; }

        /* --- Ë®àÊôÇÂô®ÁâπÂÆöÊ®£Âºè (NEW) --- */
        .timer-tabs { display: flex; background: #eee; border-radius: 10px; padding: 4px; margin-bottom: 15px; }
        .tab-btn { flex: 1; border: none; background: transparent; padding: 8px; border-radius: 8px; cursor: pointer; font-weight: bold; color: #777; }
        .tab-btn.active { background: white; color: #2196F3; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .timer-display {
            font-size: 60px; font-weight: bold; text-align: center; color: #333; font-family: 'Courier New', monospace;
            margin: 10px 0; letter-spacing: 2px;
        }
        .timer-display.red-alert { color: #ff5252; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .timer-controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; }
        .control-btn {
            width: 50px; height: 50px; border-radius: 50%; border: none; font-size: 20px; cursor: pointer;
            display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-play { background: #4CAF50; color: white; }
        .btn-pause { background: #FFC107; color: white; }
        .btn-reset { background: #eee; color: #555; }

        .preset-btns { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .preset-btn {
            border: 1px solid #ddd; background: white; padding: 8px; border-radius: 8px; cursor: pointer;
            font-size: 14px; color: #555; transition: background 0.2s;
        }
        .preset-btn:hover { background: #f0f0f0; }

    </style>
</head>
<body>

    <div id="bg-layer"></div>

    <div class="class-bar">
        <button class="class-btn active" onclick="switchClass(1)">1 Áè≠</button>
        <button class="class-btn" onclick="switchClass(2)">2 Áè≠</button>
        <button class="class-btn" onclick="switchClass(3)">3 Áè≠</button>
        <button class="class-btn" onclick="switchClass(4)">4 Áè≠</button>
        <button class="class-btn" onclick="switchClass(5)">5 Áè≠</button>
        <button class="class-btn" onclick="switchClass(6)">6 Áè≠</button>
    </div>

    <div class="dock-container">
        <button class="dock-btn" onclick="toggleWidget('widget-timer')">‚è≥</button>
        <button class="dock-btn" onclick="toggleWidget('widget-scores')">üèÜ</button>
        <button class="dock-btn" onclick="toggleWidget('widget-homework')">üìù</button>
    </div>

    <div id="widget-timer" class="widget-window" style="left: 50px; top: 80px;">
        <div class="window-header">
            <span class="window-title">Ë®àÊôÇÂô®</span>
            <span class="close-btn" onclick="toggleWidget('widget-timer')">√ó</span>
        </div>
        <div class="window-content">
            <div class="timer-tabs">
                <button class="tab-btn active" onclick="switchTimerMode('countdown')">ÂÄíÊï∏Ë®àÊôÇ</button>
                <button class="tab-btn" onclick="switchTimerMode('stopwatch')">Ê≠£ÂêëË®àÊôÇ</button>
            </div>
            
            <div class="timer-display" id="timer-text">05:00</div>
            
            <div class="timer-controls">
                <button class="control-btn btn-reset" onclick="resetTimer()">‚Ü∫</button>
                <button class="control-btn btn-play" id="play-btn" onclick="toggleTimer()">‚ñ∂</button>
            </div>

            <div class="preset-btns" id="preset-area">
                <button class="preset-btn" onclick="addTime(10)">+10Áßí</button>
                <button class="preset-btn" onclick="addTime(60)">+1ÂàÜ</button>
                <button class="preset-btn" onclick="addTime(300)">+5ÂàÜ</button>
            </div>
        </div>
    </div>

    <div id="widget-scores" class="widget-window" style="left: 420px; top: 80px;">
        <div class="window-header">
            <div><span class="window-title">Â∞èÁµÑÁ´∂Ë≥Ω</span><span class="window-subtitle" id="title-class-score">1 Áè≠</span></div>
            <span class="close-btn" onclick="toggleWidget('widget-scores')">√ó</span>
        </div>
        <div class="window-content">
            <div class="score-grid" id="score-grid"></div>
            <div style="text-align:center; margin-top:10px;">
                <button onclick="resetScores()" style="text-decoration:underline; border:none; background:none; color:#999; cursor:pointer;">Êú¨Áè≠Ê≠∏Èõ∂</button>
            </div>
        </div>
    </div>

    <div id="widget-homework" class="widget-window" style="left: 50px; top: 450px;">
        <div class="window-header">
            <div><span class="window-title">‰ΩúÊ•≠ÁôªË®ò</span><span class="window-subtitle" id="title-class-hw">1 Áè≠</span></div>
            <span class="close-btn" onclick="toggleWidget('widget-homework')">√ó</span>
        </div>
        <div class="window-content">
            <div class="hw-grid" id="hw-grid"></div>
            <div class="hw-summary" id="hw-summary">Áµ±Ë®à‰∏≠...</div>
            <div style="text-align:center; margin-top:10px;">
                <button onclick="resetHomework()" style="text-decoration:underline; border:none; background:none; color:#999; cursor:pointer;">Êú¨Áè≠ÈáçÁΩÆ</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        //  Ê®°ÁµÑ C: Ë®àÊôÇÂô® (Timer Logic) ‚òÖ NEW
        // ==========================================
        let timerMode = 'countdown'; // 'countdown' or 'stopwatch'
        let timeRemaining = 300; // È†êË®≠ 5ÂàÜÈêò (Áßí)
        let stopwatchTime = 0;
        let timerInterval = null;
        let isRunning = false;

        function switchTimerMode(mode) {
            timerMode = mode;
            isRunning = false;
            clearInterval(timerInterval);
            
            // UI ÂàáÊèõ
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // ÊåâÈàïÈ°ØÁ§∫ÈÇèËºØ
            document.getElementById('play-btn').innerText = '‚ñ∂';
            document.getElementById('play-btn').className = 'control-btn btn-play';
            document.getElementById('timer-text').classList.remove('red-alert');

            if (mode === 'countdown') {
                document.getElementById('preset-area').style.display = 'grid';
                timeRemaining = 300; // ÈáçÁΩÆÂõû 5 ÂàÜ
                updateTimerDisplay(timeRemaining);
            } else {
                document.getElementById('preset-area').style.display = 'none';
                stopwatchTime = 0;
                updateTimerDisplay(stopwatchTime);
            }
        }

        function updateTimerDisplay(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            document.getElementById('timer-text').innerText = `${m}:${s}`;
        }

        function toggleTimer() {
            const btn = document.getElementById('play-btn');
            
            if (isRunning) {
                // Êö´ÂÅú
                clearInterval(timerInterval);
                isRunning = false;
                btn.innerText = '‚ñ∂';
                btn.className = 'control-btn btn-play';
            } else {
                // ÈñãÂßã
                isRunning = true;
                btn.innerText = '‚è∏';
                btn.className = 'control-btn btn-pause';
                
                timerInterval = setInterval(() => {
                    if (timerMode === 'countdown') {
                        if (timeRemaining > 0) {
                            timeRemaining--;
                            updateTimerDisplay(timeRemaining);
                        } else {
                            // ÊôÇÈñìÂà∞
                            timeUp();
                        }
                    } else {
                        // Ê≠£ÂêëË®àÊôÇ
                        stopwatchTime++;
                        updateTimerDisplay(stopwatchTime);
                    }
                }, 1000);
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            document.getElementById('play-btn').innerText = '‚ñ∂';
            document.getElementById('play-btn').className = 'control-btn btn-play';
            document.getElementById('timer-text').classList.remove('red-alert');
            
            if (timerMode === 'countdown') {
                timeRemaining = 300;
                updateTimerDisplay(timeRemaining);
            } else {
                stopwatchTime = 0;
                updateTimerDisplay(stopwatchTime);
            }
        }

        function addTime(seconds) {
            if (timerMode === 'countdown') {
                timeRemaining += seconds;
                updateTimerDisplay(timeRemaining);
            }
        }

        function timeUp() {
            clearInterval(timerInterval);
            isRunning = false;
            document.getElementById('play-btn').innerText = '‚ñ∂';
            document.getElementById('play-btn').className = 'control-btn btn-play';
            document.getElementById('timer-text').classList.add('red-alert');
            playBeepSound(); // Êí≠ÊîæÈü≥Êïà
        }

        // --- ÁÄèË¶ΩÂô®ÂÖßÂª∫Èü≥ÊïàÁî¢ÁîüÂô® (ÁÑ°ÈúÄ mp3) ---
        function playBeepSound() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gainNode = ctx.createGain();

            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, ctx.currentTime); // 880Hz (È´òÈü≥)
            osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.5); // ÈôçË™øÊïàÊûú

            gainNode.gain.setValueAtTime(0.5, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);

            osc.connect(gainNode);
            gainNode.connect(ctx.destination);

            osc.start();
            osc.stop(ctx.currentTime + 0.5); // Èüø 0.5 Áßí
            
            // ÈÄ£Á∫åÈüø‰∏âËÅ≤
            setTimeout(() => {
                const osc2 = ctx.createOscillator();
                const gain2 = ctx.createGain();
                osc2.connect(gain2);
                gain2.connect(ctx.destination);
                osc2.start();
                osc2.stop(ctx.currentTime + 0.5); 
            }, 600);
        }

        // ==========================================
        //  ÂÖ∂‰ªñÁ≥ªÁµ±ÂäüËÉΩ (Á∂≠ÊåÅ v4 ÁâàÈÇèËºØ)
        // ==========================================
        let currentClass = parseInt(localStorage.getItem('currentActiveIdx')) || 1;
        const STUDENT_COUNT = 30;

        updateClassUI();
        loadAllData();

        function switchClass(classIdx) {
            currentClass = classIdx;
            localStorage.setItem('currentActiveIdx', currentClass);
            updateClassUI();
            loadAllData();
        }

        function updateClassUI() {
            document.querySelectorAll('.class-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', idx + 1 === currentClass);
            });
            document.getElementById('title-class-score').innerText = `${currentClass} Áè≠`;
            document.getElementById('title-class-hw').innerText = `${currentClass} Áè≠`;
        }

        function loadAllData() {
            renderScores();
            renderHomework();
        }

        // --- ÂàÜÊï∏ÈÇèËºØ ---
        const defaultScores = [{ icon: 'ü¶Å', score: 0 }, { icon: 'üê∞', score: 0 }, { icon: 'üêº', score: 0 }, { icon: 'ü¶ä', score: 0 }];
        function getScoreData() { return JSON.parse(localStorage.getItem(`class_${currentClass}_scores`)) || JSON.parse(JSON.stringify(defaultScores)); }
        function saveScoreData(data) { localStorage.setItem(`class_${currentClass}_scores`, JSON.stringify(data)); }
        function renderScores() {
            const grid = document.getElementById('score-grid');
            grid.innerHTML = '';
            getScoreData().forEach((group, index) => {
                grid.innerHTML += `<div class="score-card"><span class="score-animal">${group.icon}</span><div class="score-value">${group.score}</div><div class="score-actions"><button class="btn-minus" onclick="updateScore(${index}, -1)">-</button><button class="btn-add" onclick="updateScore(${index}, 1)">+</button></div></div>`;
            });
        }
        function updateScore(i, c) { let d = getScoreData(); d[i].score = Math.max(0, d[i].score + c); saveScoreData(d); renderScores(); }
        function resetScores() { if(confirm(`Ê≠∏Èõ∂ ${currentClass} Áè≠ÂàÜÊï∏Ôºü`)) { saveScoreData(JSON.parse(JSON.stringify(defaultScores))); renderScores(); }}

        // --- ‰ΩúÊ•≠ÈÇèËºØ ---
        function getHWData() { return JSON.parse(localStorage.getItem(`class_${currentClass}_homework`)) || new Array(STUDENT_COUNT).fill(0); }
        function saveHWData(data) { localStorage.setItem(`class_${currentClass}_homework`, JSON.stringify(data)); }
        function renderHomework() {
            const grid = document.getElementById('hw-grid');
            grid.innerHTML = ''; let done=0, miss=0;
            getHWData().forEach((st, i) => {
                let cls = st===1 ? 'status-done' : (st===2 ? 'status-missing' : '');
                if(st===1) done++; if(st===2) miss++;
                grid.innerHTML += `<div class="student-circle ${cls}" onclick="toggleHW(${i})">${i+1}</div>`;
            });
            document.getElementById('hw-summary').innerHTML = `${currentClass}Áè≠ - Â∑≤‰∫§:<b>${done}</b> | <span style="color:red">Áº∫‰∫§:<b>${miss}</b></span>`;
        }
        function toggleHW(i) { let d = getHWData(); d[i] = (d[i]+1)%3; saveHWData(d); renderHomework(); }
        function resetHomework() { if(confirm(`ÈáçÁΩÆ ${currentClass} Áè≠‰ΩúÊ•≠Ôºü`)) { saveHWData(new Array(STUDENT_COUNT).fill(0)); renderHomework(); }}

        // --- ÊãñÊõ≥Á≥ªÁµ± ---
        let zIndexCounter = 100;
        function makeDraggable(el) {
            const header = el.querySelector('.window-header');
            let isD = false, sX, sY, iL, iT;
            const start = (e) => {
                el.style.zIndex = ++zIndexCounter;
                const cX = e.touches ? e.touches[0].clientX : e.clientX;
                const cY = e.touches ? e.touches[0].clientY : e.clientY;
                isD = true; sX = cX; sY = cY; iL = el.offsetLeft; iT = el.offsetTop;
            };
            const move = (e) => {
                if(!isD) return; e.preventDefault();
                const cX = e.touches ? e.touches[0].clientX : e.clientX;
                const cY = e.touches ? e.touches[0].clientY : e.clientY;
                el.style.left = `${iL + (cX - sX)}px`; el.style.top = `${iT + (cY - sY)}px`;
            };
            const end = () => { isD = false; };
            header.addEventListener("mousedown", start); header.addEventListener("touchstart", start, {passive:false});
            document.addEventListener("mousemove", move); document.addEventListener("touchmove", move, {passive:false});
            document.addEventListener("mouseup", end); document.addEventListener("touchend", end);
        }
        document.querySelectorAll('.widget-window').forEach(win => makeDraggable(win));
        function toggleWidget(id) {
            const el = document.getElementById(id);
            if (el.style.display === 'flex') { el.style.display = 'none'; } 
            else { el.style.display = 'flex'; el.style.zIndex = ++zIndexCounter; }
        }
    </script>
</body>
</html>
