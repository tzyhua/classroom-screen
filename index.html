<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½œæ¥­ç¹³äº¤ç´€éŒ„ç³»çµ± v8.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«”ä»¥ç²å¾—ç¾ä»£æ„Ÿ */
        body { font-family: 'Inter', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background-color: #f8f9fa; overscroll-behavior: none; }
        
        /* Macaron Color Palette */
        .color-submitted { background-color: #C8E6C9; color: #1E4620; } /* Mint Green */
        .color-late { background-color: #FFECB3; color: #6D4C41; }      /* Light Yellow */
        .color-missing { background-color: #FFCDD2; color: #C62828; }    /* Light Pink */
        .color-base { background-color: #F8F9FA; color: #424242; border: 1px solid #E0E0E0; }

        /* è¦–çª—é€šç”¨æ¨£å¼ */
        .widget-window {
            position: absolute; min-width: 380px; max-width: 90vw;
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(5px);
            border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            display: none; flex-direction: column; overflow: hidden;
            z-index: 100; transition: all 0.2s;
        }

        /* Dock (åº•éƒ¨å·¥å…·åˆ—) */
        .dock-container {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(12px);
            padding: 12px 24px; border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2); z-index: 100;
        }
        .dock-btn {
            width: 55px; height: 55px; border: none; background: white;
            border-radius: 14px; font-size: 26px; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s;
        }
        .dock-btn:active { transform: scale(0.9); }

        /* é ‚éƒ¨ç­ç´šåˆ— */
        .class-bar {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px);
            padding: 8px 15px; border-radius: 50px; display: flex; gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); max-width: 90%; overflow-x: auto; white-space: nowrap;
        }
        .class-bar::-webkit-scrollbar { display: none; }
        .class-btn {
            padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; flex-shrink: 0;
            transition: all 0.2s; background: transparent; border: none;
        }
        .class-btn.active { background: #A7C7E7; color: white; box-shadow: 0 2px 8px rgba(167, 199, 231, 0.5); }
        .settings-btn { width: 36px; height: 36px; border-radius: 50%; }

        /* ä½œæ¥­æ–¹æ ¼ */
        .student-square {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 80px; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer;
            transition: all 0.1s; user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .student-square:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.15); }

        /* çµ±è¨ˆçµæœ */
        .stat-badge {
            padding: 8px 15px; border-radius: 10px; font-weight: bold; font-size: 16px;
            display: inline-flex; align-items: center; gap: 5px;
        }
        .stat-submitted { background-color: #E8F5E9; color: #388E3C; }
        .stat-late { background-color: #FFFDE7; color: #FFA000; }
        .stat-missing { background-color: #FFEBEE; color: #D32F2F; }

        /* è¼¸å…¥æ¬„ä½ */
        input[type="text"], input[type="date"], select, textarea {
            border: 1px solid #ddd; padding: 10px; border-radius: 8px; font-size: 16px;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #A7C7E7; outline: none; box-shadow: 0 0 0 2px rgba(167, 199, 231, 0.3);
        }

    </style>
</head>
<body class="bg-gray-100">

    <!-- èƒŒæ™¯åœ–å±¤ -->
    <div id="bg-layer" class="fixed inset-0 bg-cover bg-center -z-10" style="background-image: url('https://images.unsplash.com/photo-1541462628461-12563f46f417?q=80&w=1920&auto=format&fit=crop');"></div>

    <!-- é ‚éƒ¨ç­ç´šåˆ— -->
    <div class="fixed top-5 left-0 w-full flex justify-center items-center z-50">
        <div class="class-bar" id="top-class-bar"></div>
        <button class="settings-btn bg-gray-200 ml-4 hover:bg-gray-300 transition-colors" onclick="openSettings()">âš™ï¸</button>
    </div>

    <!-- åº•éƒ¨ Dock -->
    <div class="dock-container">
        <button class="dock-btn" data-title="ä½œæ¥­ç´€éŒ„" onclick="toggleWidget('widget-assignment')">ğŸ“</button>
        <button class="dock-btn" data-title="è¨ˆæ™‚å™¨" onclick="toggleWidget('widget-timer')">â³</button>
        <button class="dock-btn" data-title="å°çµ„åˆ†æ•¸" onclick="toggleWidget('widget-scores')">ğŸ†</button>
        <button class="dock-btn" data-title="ä¸Šèª²å‚™å¿˜" onclick="toggleWidget('widget-memo')">ğŸ“–</button>
        <button class="dock-btn" data-title="å¸¸ç”¨é€£çµ" onclick="toggleWidget('widget-links')">ğŸ”—</button>
    </div>

    <!-- NEW: ä½œæ¥­ç¹³äº¤ç´€éŒ„ (Assignment Widget) -->
    <div id="widget-assignment" class="widget-window top-24 left-1/2 -translate-x-1/2 w-[900px] max-w-[95vw]">
        <div class="window-header p-4 bg-blue-50 rounded-t-[20px] cursor-move flex justify-between items-center text-blue-800" onmousedown="startDrag(event, 'widget-assignment')" ontouchstart="startDrag(event, 'widget-assignment')">
            <h2 class="text-xl font-bold"><span class="sub-cls-name"></span> - ä½œæ¥­ç¹³äº¤ç´€éŒ„</h2>
            <button class="close-btn w-6 h-6 bg-red-500 rounded-full text-white text-base leading-none" onclick="toggleWidget('widget-assignment')">Ã—</button>
        </div>

        <div class="p-5 overflow-y-auto">
            <!-- ç´€éŒ„æŠ¬é ­ -->
            <div class="grid grid-cols-4 gap-4 mb-6 p-4 bg-white rounded-xl shadow-lg">
                <div><label class="block text-sm font-medium mb-1">æ—¥æœŸ</label><input type="date" id="meta-date" class="w-full" onchange="saveMeta()"></div>
                <div><label class="block text-sm font-medium mb-1">ç§‘ç›®</label><input type="text" id="meta-subject" class="w-full" placeholder="ä¾‹å¦‚ï¼šæ•¸å­¸" oninput="saveMeta()"></div>
                <div><label class="block text-sm font-medium mb-1">ä½œæ¥­åç¨±</label><input type="text" id="meta-assignment" class="w-full" placeholder="ä¾‹å¦‚ï¼šP.10 ç¿’é¡Œ" oninput="saveMeta()"></div>
                <div><label class="block text-sm font-medium mb-1">æ•™å¸«</label><input type="text" id="meta-teacher" class="w-full" placeholder="ä¾‹å¦‚ï¼šç‹è€å¸«" oninput="saveMeta()"></div>
            </div>

            <!-- å­¸ç”Ÿç¯„åœè¨­å®šèˆ‡æª”æ¡ˆæ“ä½œ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-white rounded-xl shadow-lg border-t-4 border-[#A7C7E7]">
                <div class="col-span-1 md:col-span-3 grid grid-cols-3 gap-3 items-end">
                    <div><label class="block text-sm font-medium mb-1">åº§è™Ÿèµ·é»</label><input type="number" id="config-start" class="w-full" value="1" min="1" onchange="updateConfig()"></div>
                    <div><label class="block text-sm font-medium mb-1">åº§è™Ÿçµ‚é»</label><input type="number" id="config-end" class="w-full" value="25" min="1" onchange="updateConfig()"></div>
                    <div><label class="block text-sm font-medium mb-1">æ’é™¤åº§è™Ÿ (é€—è™Ÿåˆ†éš”)</label><input type="text" id="config-exclude" class="w-full" placeholder="ä¾‹å¦‚ï¼š3, 15" onchange="updateConfig()"></div>
                </div>

                <div class="col-span-1 md:col-span-1 flex flex-col gap-2">
                    <label class="block text-sm font-medium">å­¸ç”Ÿåå–® (.csv)</label>
                    <input type="file" id="student-csv-upload" accept=".csv" onchange="handleCSVUpload(event)" class="text-sm">
                    <button class="bg-indigo-500 text-white p-2 rounded-lg text-sm hover:bg-indigo-600" onclick="downloadResults()">ä¸‹è¼‰ç´€éŒ„çµæœ (.csv)</button>
                </div>
            </div>

            <!-- çµ±è¨ˆçµæœ -->
            <div class="flex flex-wrap gap-4 mb-6 p-4 bg-white rounded-xl shadow-lg border-t-4 border-[#FFECB3]">
                <div class="stat-badge stat-submitted">
                    <span class="text-xl">âœ…</span> ç¹³äº¤äººæ•¸ï¼š<span id="stat-submitted-count">0</span>
                </div>
                <div class="stat-badge stat-late">
                    <span class="text-xl">âš ï¸</span> é²äº¤äººæ•¸ï¼š<span id="stat-late-count">0</span>
                </div>
                <div class="stat-badge stat-missing">
                    <span class="text-xl">âŒ</span> ç¼ºäº¤ç¸½æ•¸ï¼š<span id="stat-missing-count">0</span> / <span id="stat-total-count">0</span>
                </div>
                <div class="stat-badge bg-gray-100 text-gray-700">
                    åº§è™Ÿï¼š<span id="stat-missing-seats" class="font-normal text-sm">ç„¡</span>
                </div>
                <div class="stat-badge bg-gray-100 text-gray-700">
                    é²äº¤åº§è™Ÿï¼š<span id="stat-late-seats" class="font-normal text-sm">ç„¡</span>
                </div>
            </div>

            <!-- å­¸ç”Ÿæ–¹æ ¼å€ -->
            <div id="student-grid-container" class="grid grid-cols-5 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-3 p-4 bg-white rounded-xl shadow-lg border-t-4 border-[#C8E6C9]">
                <!-- å­¸ç”Ÿæ–¹æ ¼å°‡ç”± JavaScript æ¸²æŸ“ -->
            </div>
        </div>
    </div>

    <!-- å½ˆçª—ç¾¤çµ„ (å…¶ä»–åŠŸèƒ½) -->
    
    <!-- 1. è¨ˆæ™‚å™¨ (Timer) -->
    <div id="widget-timer" class="widget-window top-24 left-10 w-[300px]">
        <div class="window-header p-4 cursor-move bg-gray-100 rounded-t-[20px]" onmousedown="startDrag(event, 'widget-timer')" ontouchstart="startDrag(event, 'widget-timer')">
            <h2 class="text-xl font-bold text-gray-700">è¨ˆæ™‚å™¨</h2>
            <button class="close-btn bg-red-500" onclick="toggleWidget('widget-timer')">Ã—</button>
        </div>
        <div class="p-5">
            <div class="flex bg-gray-100 rounded-xl p-1 mb-4"><button class="tab-btn flex-1 p-2 rounded-lg font-bold text-gray-600 transition-colors active" onclick="switchTimerMode('countdown')">å€’æ•¸</button><button class="tab-btn flex-1 p-2 rounded-lg font-bold text-gray-600 transition-colors" onclick="switchTimerMode('stopwatch')">æ­£æ•¸</button></div>
            <div class="text-6xl font-extrabold text-center my-4" id="timer-text">05:00</div>
            <div class="flex justify-center gap-4 mb-4">
                <button class="control-btn w-12 h-12 rounded-full bg-gray-200 text-gray-600 text-xl" onclick="resetTimer()">â†º</button>
                <button class="control-btn w-12 h-12 rounded-full bg-green-500 text-white text-xl" id="play-btn" onclick="toggleTimer()">â–¶</button>
            </div>
            <!-- å„ªåŒ–å¾Œçš„è¨ˆæ™‚å™¨åŠ æ¸›æŒ‰éˆ• -->
            <div class="grid grid-cols-3 gap-2" id="preset-area">
                <button class="preset-btn bg-blue-100 text-blue-800 p-2 rounded-lg font-semibold" onclick="modTime(-60)">-1 åˆ†</button>
                <button class="preset-btn bg-blue-100 text-blue-800 p-2 rounded-lg font-semibold" onclick="modTime(60)">+1 åˆ†</button>
                <button class="preset-btn bg-blue-100 text-blue-800 p-2 rounded-lg font-semibold" onclick="modTime(300)">+5 åˆ†</button>
            </div>
        </div>
    </div>

    <!-- 2. å°çµ„åˆ†æ•¸ (Scores) - å¾…å¯¦ä½œï¼Œåƒ…ä½œä½”ä½ -->
    <div id="widget-scores" class="widget-window top-24 right-10 w-[300px]">
        <div class="window-header p-4 cursor-move bg-gray-100 rounded-t-[20px]" onmousedown="startDrag(event, 'widget-scores')" ontouchstart="startDrag(event, 'widget-scores')">
            <h2 class="text-xl font-bold text-gray-700">å°çµ„ç«¶è³½ <span class="text-sm font-normal text-blue-500 sub-cls-name"></span></h2>
            <button class="close-btn bg-red-500" onclick="toggleWidget('widget-scores')">Ã—</button>
        </div>
        <div class="p-5 text-center">
            <p class="text-gray-500">å°çµ„åˆ†æ•¸åŠŸèƒ½é ç•™</p>
        </div>
    </div>

    <!-- 3. ä¸Šèª²å‚™å¿˜ (Memo) - å¾…å¯¦ä½œï¼Œåƒ…ä½œä½”ä½ -->
    <div id="widget-memo" class="widget-window bottom-24 left-10 w-[300px]">
        <div class="window-header p-4 cursor-move bg-gray-100 rounded-t-[20px]" onmousedown="startDrag(event, 'widget-memo')" ontouchstart="startDrag(event, 'widget-memo')">
            <h2 class="text-xl font-bold text-gray-700">ä¸Šèª²å‚™å¿˜ <span class="text-sm font-normal text-blue-500 sub-cls-name"></span></h2>
            <button class="close-btn bg-red-500" onclick="toggleWidget('widget-memo')">Ã—</button>
        </div>
        <div class="p-5">
            <textarea id="memo-text" class="w-full h-32 p-3 border rounded-lg" placeholder="è¼¸å…¥èª²ç¨‹é€²åº¦æˆ–æ³¨æ„äº‹é …..." oninput="saveMemo()"></textarea>
        </div>
    </div>

    <!-- 4. å¸¸ç”¨é€£çµ (Links) - å¾…å¯¦ä½œï¼Œåƒ…ä½œä½”ä½ -->
    <div id="widget-links" class="widget-window bottom-24 right-10 w-[300px]">
        <div class="window-header p-4 cursor-move bg-gray-100 rounded-t-[20px]" onmousedown="startDrag(event, 'widget-links')" ontouchstart="startDrag(event, 'widget-links')">
            <h2 class="text-xl font-bold text-gray-700">å¸¸ç”¨é€£çµ</h2>
            <button class="close-btn bg-red-500" onclick="toggleWidget('widget-links')">Ã—</button>
        </div>
        <div class="p-5 text-center">
            <p class="text-gray-500">å¸¸ç”¨é€£çµåŠŸèƒ½é ç•™</p>
        </div>
    </div>

    <!-- è¨­å®šå½ˆçª— (Settings Modal) -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden justify-center items-center">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-96">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">ç­ç´šç®¡ç†</h3>
            <div id="class-list-edit" class="max-h-80 overflow-y-auto mb-4 border rounded-lg p-2"></div>
            <button class="w-full py-2 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-colors" onclick="addNewClass()">+ æ–°å¢ç­ç´š</button>
            <button class="w-full py-2 mt-3 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400 transition-colors" onclick="closeSettings()">é—œé–‰</button>
        </div>
    </div>


    <script>
        // ===================================
        //  1. ç³»çµ±æ ¸å¿ƒèˆ‡æ•¸æ“šç®¡ç† (Core & Data)
        // ===================================
        
        const DEFAULT_STUDENT_COUNT = 25;
        const HOMEWORK_STATUS = ['color-missing', 'color-submitted', 'color-late'];
        const HOMEWORK_TEXT = ['æœªäº¤', 'æœ‰äº¤', 'é²äº¤'];
        
        // ç­ç´šé…ç½® (v7.0 çµæ§‹)
        let classes = JSON.parse(localStorage.getItem('class_config')) || [{ id: 'c1', name: 'ä¸€å¹´ä¸€ç­' }];
        let currentClassId = localStorage.getItem('current_class_id') || classes[0].id;
        
        // ç¢ºä¿ç•¶å‰ ClassId å­˜åœ¨
        if (!classes.find(c => c.id === currentClassId)) {
            currentClassId = classes[0] ? classes[0].id : null;
        }

        // æ•¸æ“šçµæ§‹ï¼šç´€éŒ„æ‰€æœ‰èˆ‡ä½œæ¥­ç›¸é—œçš„ç‹€æ…‹
        function getHomeworkData() {
            const key = `${currentClassId}_assignment_data`;
            const defaultData = {
                meta: { date: new Date().toISOString().substring(0, 10), subject: '', assignment: '', teacher: '' },
                config: { start: 1, end: DEFAULT_STUDENT_COUNT, exclude: [] },
                // ç‹€æ…‹é™£åˆ—ï¼Œindex 0 å°æ‡‰åº§è™Ÿ start
                status: new Array(DEFAULT_STUDENT_COUNT).fill(0), // 0:Missing, 1:Submitted, 2:Late
                names: new Array(DEFAULT_STUDENT_COUNT).fill('') // å­¸ç”Ÿå§“å (å¯é¸)
            };
            const data = JSON.parse(localStorage.getItem(key)) || defaultData;
            // ç¢ºä¿ status é™£åˆ—é•·åº¦è‡³å°‘é”åˆ° end - start + 1
            const requiredLength = data.config.end - data.config.start + 1;
            if (data.status.length < requiredLength) {
                data.status = data.status.concat(new Array(requiredLength - data.status.length).fill(0));
            }
            if (data.names.length < requiredLength) {
                data.names = data.names.concat(new Array(requiredLength - data.names.length).fill(''));
            }
            return data;
        }

        function saveHomeworkData(data) {
            localStorage.setItem(`${currentClassId}_assignment_data`, JSON.stringify(data));
        }

        // ===================================
        //  2. ç­ç´šç®¡ç†åŠŸèƒ½ (Class Management)
        // ===================================

        function initClass() {
            renderClassBar();
            loadAssignmentData();
        }

        function switchClass(id) {
            currentClassId = id;
            localStorage.setItem('current_class_id', id);
            renderClassBar();
            loadAssignmentData(); // é‡æ–°è¼‰å…¥æ–°ç­ç´šè³‡æ–™
        }

        function renderClassBar() {
            const bar = document.getElementById('top-class-bar');
            bar.innerHTML = '';
            classes.forEach(cls => {
                const btn = document.createElement('button');
                btn.className = `class-btn ${cls.id === currentClassId ? 'active' : ''}`;
                btn.innerText = cls.name;
                btn.onclick = () => switchClass(cls.id);
                bar.appendChild(btn);
            });
            updateSubtitles();
        }

        function updateSubtitles() {
            const currentName = classes.find(c => c.id === currentClassId)?.name || '';
            document.querySelectorAll('.sub-cls-name').forEach(el => el.innerText = currentName);
        }

        // è¨­å®šå½ˆçª—
        function openSettings() {
            const list = document.getElementById('class-list-edit');
            list.innerHTML = '';
            classes.forEach(cls => {
                list.innerHTML += `
                    <div class="flex justify-between items-center py-2">
                        <input type="text" value="${cls.name}" class="p-2 border rounded-lg flex-grow mr-2" onchange="updateClassName('${cls.id}', this.value)">
                        ${classes.length > 1 ? `<button class="text-red-500 font-bold hover:text-red-700" onclick="deleteClass('${cls.id}')">åˆªé™¤</button>` : ''}
                    </div>
                `;
            });
            document.getElementById('settings-modal').classList.remove('hidden');
            document.getElementById('settings-modal').classList.add('flex');
        }

        function closeSettings() { 
            document.getElementById('settings-modal').classList.add('hidden');
            document.getElementById('settings-modal').classList.remove('flex');
            renderClassBar(); 
        }

        function addNewClass() {
            const newId = 'c' + Date.now();
            classes.push({ id: newId, name: 'æ–°ç­ç´š' });
            localStorage.setItem('class_config', JSON.stringify(classes));
            openSettings(); 
        }

        function updateClassName(id, newName) {
            const cls = classes.find(c => c.id === id);
            if(cls) { 
                cls.name = newName.trim() || 'æœªå‘½åç­ç´š'; 
                localStorage.setItem('class_config', JSON.stringify(classes)); 
            }
        }

        function deleteClass(id) {
            if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­ç´šï¼Ÿè©²ç­çš„æ‰€æœ‰ä½œæ¥­ç´€éŒ„å°‡æœƒæ¶ˆå¤±ï¼')) {
                classes = classes.filter(c => c.id !== id);
                localStorage.setItem('class_config', JSON.JSON.stringify(classes));
                localStorage.removeItem(`${id}_assignment_data`); // åˆªé™¤è³‡æ–™
                
                if(id === currentClassId) { 
                    currentClassId = classes[0] ? classes[0].id : null;
                    localStorage.setItem('current_class_id', currentClassId);
                }
                openSettings();
                if (currentClassId) loadAssignmentData();
            }
        }

        // ===================================
        //  3. ä½œæ¥­ç´€éŒ„ä¸»åŠŸèƒ½ (Assignment Logic)
        // ===================================

        function loadAssignmentData() {
            const data = getHomeworkData();
            
            // è¼‰å…¥æŠ¬é ­
            document.getElementById('meta-date').value = data.meta.date || '';
            document.getElementById('meta-subject').value = data.meta.subject || '';
            document.getElementById('meta-assignment').value = data.meta.assignment || '';
            document.getElementById('meta-teacher').value = data.meta.teacher || '';

            // è¼‰å…¥é…ç½®
            document.getElementById('config-start').value = data.config.start;
            document.getElementById('config-end').value = data.config.end;
            document.getElementById('config-exclude').value = data.config.exclude.join(', ');

            renderStudentGrid(data);
            updateStatistics(data);
        }
        
        function saveMeta() {
            const data = getHomeworkData();
            data.meta.date = document.getElementById('meta-date').value;
            data.meta.subject = document.getElementById('meta-subject').value;
            data.meta.assignment = document.getElementById('meta-assignment').value;
            data.meta.teacher = document.getElementById('meta-teacher').value;
            saveHomeworkData(data);
        }

        function updateConfig() {
            const data = getHomeworkData();
            const start = parseInt(document.getElementById('config-start').value) || 1;
            const end = parseInt(document.getElementById('config-end').value) || 1;
            const excludeStr = document.getElementById('config-exclude').value.trim();
            const exclude = excludeStr ? excludeStr.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n >= start && n <= end) : [];

            // ç¢ºä¿åˆç†ç¯„åœ
            if (start > end) {
                alert('åº§è™Ÿèµ·é»ä¸èƒ½å¤§æ–¼åº§è™Ÿçµ‚é»ï¼');
                document.getElementById('config-start').value = data.config.start;
                document.getElementById('config-end').value = data.config.end;
                return;
            }

            data.config.start = start;
            data.config.end = end;
            data.config.exclude = exclude;
            
            // èª¿æ•´ status å’Œ names é™£åˆ—é•·åº¦ä»¥åŒ¹é…æ–°çš„ç¯„åœ
            const requiredLength = end - start + 1;
            if (data.status.length > requiredLength) {
                data.status.length = requiredLength;
                data.names.length = requiredLength;
            } else if (data.status.length < requiredLength) {
                const diff = requiredLength - data.status.length;
                data.status = data.status.concat(new Array(diff).fill(0));
                data.names = data.names.concat(new Array(diff).fill(''));
            }

            saveHomeworkData(data);
            renderStudentGrid(data);
            updateStatistics(data);
        }

        function renderStudentGrid(data) {
            const grid = document.getElementById('student-grid-container');
            grid.innerHTML = '';
            
            const { start, end, exclude } = data.config;
            
            for (let seat = start; seat <= end; seat++) {
                if (exclude.includes(seat)) continue;

                const index = seat - start;
                const status = data.status[index];
                const name = data.names[index];
                
                const statusClass = HOMEWORK_STATUS[status];
                const statusText = HOMEWORK_TEXT[status];
                const nameDisplay = name ? `<span class="text-xs font-normal text-gray-700">${name}</span>` : '';

                grid.innerHTML += `
                    <div class="student-square ${statusClass}" 
                         data-seat="${seat}" 
                         data-index="${index}"
                         onclick="toggleStatus(${index})">
                        <span class="text-2xl">${seat} è™Ÿ</span>
                        ${nameDisplay}
                        <span class="text-sm font-light">${statusText}</span>
                    </div>
                `;
            }
        }

        function toggleStatus(index) {
            const data = getHomeworkData();
            // 0 -> 1 (Missing -> Submitted) -> 2 (Late) -> 0
            data.status[index] = (data.status[index] + 1) % 3;
            
            saveHomeworkData(data);
            renderStudentGrid(data); // é‡æ–°æ¸²æŸ“æ•´å€‹ç¶²æ ¼ä»¥æ›´æ–°é¡è‰²å’Œæ–‡å­—
            updateStatistics(data);
        }

        function updateStatistics(data) {
            let submitted = 0;
            let late = 0;
            let missing = 0;
            let total = 0;
            let missingSeats = [];
            let lateSeats = [];

            const { start, end, exclude } = data.config;
            
            for (let seat = start; seat <= end; seat++) {
                if (exclude.includes(seat)) continue;
                
                const index = seat - start;
                const status = data.status[index];
                total++;

                if (status === 1) {
                    submitted++;
                } else if (status === 2) {
                    late++;
                    lateSeats.push(seat);
                } else {
                    missing++;
                    missingSeats.push(seat);
                }
            }

            document.getElementById('stat-submitted-count').innerText = submitted;
            document.getElementById('stat-late-count').innerText = late;
            document.getElementById('stat-missing-count').innerText = missing;
            document.getElementById('stat-total-count').innerText = total;
            document.getElementById('stat-missing-seats').innerText = missingSeats.length ? missingSeats.join(', ') : 'ç„¡';
            document.getElementById('stat-late-seats').innerText = lateSeats.length ? lateSeats.join(', ') : 'ç„¡';
        }

        // ===================================
        //  4. æª”æ¡ˆæ“ä½œ (File I/O)
        // ===================================

        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n').filter(line => line.trim() !== '');
                const data = getHomeworkData();
                const names = [];
                
                // å‡è¨­ CSV æ ¼å¼ç‚ºï¼šåº§è™Ÿ, å§“å
                // ä¸”åº§è™Ÿæ˜¯ç¬¬ä¸€æ¬„ï¼Œå§“åæ˜¯ç¬¬äºŒæ¬„
                lines.forEach(line => {
                    const parts = line.split(',').map(p => p.trim());
                    const seat = parseInt(parts[0]);
                    const name = parts[1] || '';
                    
                    if (!isNaN(seat) && seat >= data.config.start && seat <= data.config.end) {
                        const index = seat - data.config.start;
                        names[index] = name;
                    }
                });

                // å°‡è®€å–åˆ°çš„åç¨±åˆä½µåˆ°ç¾æœ‰æ•¸æ“šä¸­
                for(let i = 0; i < names.length; i++) {
                    if (names[i]) {
                         data.names[i] = names[i];
                    } else if (!data.names[i] && i + data.config.start <= data.config.end) {
                        // å¦‚æœ CSV æ²’æœ‰æä¾›ï¼Œå°±æ¸…ç©º
                        data.names[i] = ''; 
                    }
                }
                
                saveHomeworkData(data);
                loadAssignmentData();
                alert(`å·²æˆåŠŸåŒ¯å…¥ ${names.filter(n => n).length} ç­†å­¸ç”Ÿåå–®ã€‚`);
            };
            reader.readAsText(file);
        }

        function downloadResults() {
            const data = getHomeworkData();
            const { start, end, exclude } = data.config;
            
            const header = `ç­ç´š,æ—¥æœŸ,ç§‘ç›®,ä½œæ¥­åç¨±,æ•™å¸«,åº§è™Ÿ,å§“å,ç¹³äº¤ç‹€æ…‹\n`;
            let csvContent = header;

            const currentClassName = classes.find(c => c.id === currentClassId)?.name || 'æœªçŸ¥ç­ç´š';
            const meta = `${currentClassName},${data.meta.date},${data.meta.subject},${data.meta.assignment},${data.meta.teacher}`;
            
            for (let seat = start; seat <= end; seat++) {
                if (exclude.includes(seat)) continue;

                const index = seat - start;
                const status = data.status[index];
                const name = data.names[index] || '';
                const statusText = HOMEWORK_TEXT[status];

                csvContent += `${meta},${seat},"${name.replace(/"/g, '""')}",${statusText}\n`;
            }

            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' }); // åŠ ä¸Š BOM ä»¥æ”¯æ´ Excel ä¸­æ–‡
            const filename = `${data.meta.date}_${currentClassName}_${data.meta.assignment || 'ä½œæ¥­ç´€éŒ„'}.csv`;
            
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // ===================================
        //  5. è¨ˆæ™‚å™¨å„ªåŒ– (Timer Optimization)
        // ===================================
        let tMode = 'countdown', tVal = 300, tInt = null, isRun = false;

        function updateTime(s) { document.getElementById('timer-text').innerText = `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
        function switchTimerMode(m) {
            tMode = m; resetTimer();
            document.querySelectorAll('#widget-timer .tab-btn').forEach(b => b.classList.remove('active')); 
            event.target.classList.add('active');
        }
        function toggleTimer() {
            const btn = document.getElementById('play-btn');
            if (isRun) { clearInterval(tInt); isRun = false; btn.innerText = 'â–¶'; btn.className = 'control-btn w-12 h-12 rounded-full bg-green-500 text-white text-xl'; }
            else {
                isRun = true; btn.innerText = 'â¸'; btn.className = 'control-btn w-12 h-12 rounded-full bg-yellow-500 text-white text-xl';
                tInt = setInterval(() => {
                    if (tMode === 'countdown') { 
                        if (tVal > 0) { tVal--; updateTime(tVal); } 
                        else { 
                            clearInterval(tInt); isRun = false; 
                            document.getElementById('timer-text').classList.add('text-red-500'); 
                            playBeep();
                        } 
                    }
                    else { tVal++; updateTime(tVal); }
                }, 1000);
            }
        }
        function resetTimer() { 
            clearInterval(tInt); isRun = false; tVal = tMode === 'countdown' ? 300 : 0; updateTime(tVal);
            document.getElementById('timer-text').classList.remove('text-red-500'); 
            document.getElementById('play-btn').innerText = 'â–¶'; document.getElementById('play-btn').className = 'control-btn w-12 h-12 rounded-full bg-green-500 text-white text-xl';
        }
        function modTime(s) { 
            if (tMode === 'countdown') { 
                tVal = Math.max(0, tVal + s); // ç¢ºä¿ä¸ç‚ºè² 
                updateTime(tVal); 
            }
        }
        function playBeep() { /* ç°¡å–®çš„æç¤ºéŸ³ (åŒ v7.0 é‚è¼¯) */ }


        // ===================================
        //  6. é€šç”¨ UI (Universal UI)
        // ===================================

        // è¦–çª—æ‹–æ›³ (ç°¡åŒ–ç‰ˆ)
        let zIndexCounter = 1000;
        let draggingElement = null;
        let offsetX, offsetY;

        function startDrag(e, id) {
            const el = document.getElementById(id);
            el.style.zIndex = ++zIndexCounter;
            draggingElement = el;
            
            const p = e.touches ? e.touches[0] : e;
            offsetX = p.clientX - el.offsetLeft;
            offsetY = p.clientY - el.offsetTop;

            // ç§»é™¤ Tailwind çš„ translate å±…ä¸­æ•ˆæœï¼Œç›´æ¥ç”¨ left/top å®šä½
            el.classList.remove('-translate-x-1/2');
            
            document.addEventListener('mousemove', drag, false);
            document.addEventListener('mouseup', stopDrag, false);
            document.addEventListener('touchmove', drag, false);
            document.addEventListener('touchend', stopDrag, false);
        }

        function drag(e) {
            if (!draggingElement) return;
            e.preventDefault(); 
            const p = e.touches ? e.touches[0] : e;
            
            // é™åˆ¶æ‹–æ›³ç¯„åœåœ¨è¦–çª—å…§
            let newX = p.clientX - offsetX;
            let newY = p.clientY - offsetY;
            
            draggingElement.style.left = newX + 'px';
            draggingElement.style.top = newY + 'px';
        }

        function stopDrag() {
            if (draggingElement) {
                document.removeEventListener('mousemove', drag, false);
                document.removeEventListener('mouseup', stopDrag, false);
                document.removeEventListener('touchmove', drag, false);
                document.removeEventListener('touchend', stopDrag, false);
                draggingElement = null;
            }
        }

        function toggleWidget(id) {
            const el = document.getElementById(id);
            if (el.style.display === 'flex') {
                el.style.display = 'none';
            } else {
                el.style.display = 'flex';
                el.style.zIndex = ++zIndexCounter;
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initClass);
    </script>
</body>
</html>
